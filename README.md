# simple-cpu-dra-driver

> **⚠️ Proof of Concept: This driver is in the very early stages of
> development.**
>
> This project is a **Proof of Concept (POC)** and is not suitable for
> production use. It is under active development, and the code should be
> considered experimental.
>
> - There are currently **no unit or end-to-end tests**.
> - The code may contain **bugs and breaking changes** may be introduced
>   frequently.

## Overview

The `simple-cpu-dra-driver` is a Kubernetes
[Dynamic Resource Allocation (DRA)](https://kubernetes.io/docs/concepts/scheduling-eviction/dynamic-resource-allocation/)
driver that enables CPU pinning for workloads using DRA framework. This project
uses a combination of a DRA driver and an NRI (Node Resource Interface) plugin
to manage CPU allocations. It ensures that high-priority pods requesting
exclusive CPUs through Resource Claim get them, while also managing the
remaining CPUs for shared (BestEffort) pods.

This implements the proposal from the
[feasibility doc](https://docs.google.com/document/d/1Tb_dC60YVCBr7cNYWuVLddUUTMcNoIt3zjd5-8rgug0/edit?tab=t.0#heading=h.iutbebngx80e)

## Requirements

- Kubernetes Version: v1.33 or higher.
- Feature Gates: The following feature gates must be enabled in your cluster.
  - `DynamicResourceAllocation`
  - `DRAResourceClaimDeviceStatus`
- Kubelet CPUManager: The Kubelet's default CPUManager policy must be set to
  none, as this driver takes full responsibility for CPU pinning.
- Pod Specs: Pods requesting exclusive CPUs via a ResourceClaim should also
  include standard CPU requests to ensure the Kubernetes scheduler can make
  correct placement decisions.

## How it Works

The driver is deployed as a DaemonSet which contains two core components:

- DRA driver: The DRA driver is responsible for:
  - Discovering available CPUs on the node and reporting them to the scheduler
    by creating `ResourceSlice` object.
  - In the `PrepareResourceClaims` DRA hook, the driver parses allocated CPUs
    and generates a CDI file for that claim. This information is used by the NRI
    plugin for actuation.
- NRI Plugin: In the `CreateContainer` hook, the NRI plugin reads the CPU
  assignments for the container specified by the DRA driver and uses them to pin
  containers to their designated cores. It also ensures that any containers not
  requesting guaranteed cpu's (containers without any resource claims) are
  confined to the shared pool of available CPUs.

## Feature Support

### Currently Supported

- Exclusive CPU Allocation: Guaranteed pods that request CPUs via a
  ResourceClaim are allocated exclusive cores.
- Shared CPU Pool Management: All other containers without a ResourceClaim are
  confined to a shared pool of CPUs that are not reserved for Guaranteed pods.
- Handle daemonset restart. On restart, the driver synchronizes with all
  existing pods on the node to rebuild its state of CPU allocations, ensuring
  accurate CPU allocation for newly scheduled pods.

### Not Supported

- This driver currently only manages CPU resources. Memory allocation and
  management are not supported.

## Getting Started

### Installation

- Create a kind cluster
  - `kind create cluster --config kind.yaml`
- Deploy the driver and all necessary RBAC configurations using the provided
  manifest
  - `kubectl apply -f install.yaml`

### Example Usage

- Create a DeviceClass: This tells Kubernetes how to find the resources provided
  by this driver.
  - `kubectl apply -f examples/sample_device_class.yaml`
- Create a ResourceClaim: This requests a specific number of exclusive CPUs from
  the driver.
  - `kubectl apply -f examples/sample_resource_claim.yaml`
- Create a Pod: Reference the ResourceClaim in your pod spec to receive the
  allocated CPUs.
  - `kubectl apply -f examples/sample_pod.yaml`

### Example Driver Artifacts

- ResourceSLice (generated by the driver)

```
apiVersion: resource.k8s.io/v1beta2
kind: ResourceSlice
metadata:
  creationTimestamp: "2025-07-08T23:30:49Z"
  generateName: kind-worker-dra.cpu-
  generation: 1
  name: kind-worker-dra.cpu-qbxxr
  ownerReferences:
  - apiVersion: v1
    controller: true
    kind: Node
    name: kind-worker
    uid: cc541bab-f80a-454d-9995-8e24d6cd69c0
  resourceVersion: "746"
  uid: fab29215-023f-422f-ab7e-42c437de7d49
spec:
  devices:
  - attributes:
      coreID:
        int: 0
      cpuID:
        int: 0
      numaAffinityMask:
        string: 0x000000ffffff000000ffffff
      numaNode:
        int: 0
    name: cpu0
  - attributes:
      coreID:
        int: 1
      cpuID:
        int: 1
      numaAffinityMask:
        string: 0x000000ffffff000000ffffff
      numaNode:
        int: 0
    name: cpu1
  - attributes:
      coreID:
        int: 2
      cpuID:
        int: 2
      numaAffinityMask:
        string: 0x000000ffffff000000ffffff
      numaNode:
        int: 0
    name: cpu2
  - attributes:
      coreID:
        int: 3
      cpuID:
        int: 3
      numaAffinityMask:
        string: 0x000000ffffff000000ffffff
      numaNode:
        int: 0
    name: cpu3
    ...
    ...
    ...
  - attributes:
      coreID:
        int: 21
      cpuID:
        int: 93
      numaAffinityMask:
        string: 0xffffff000000ffffff000000
      numaNode:
        int: 1
    name: cpu93
  - attributes:
      coreID:
        int: 22
      cpuID:
        int: 94
      numaAffinityMask:
        string: 0xffffff000000ffffff000000
      numaNode:
        int: 1
    name: cpu94
  - attributes:
      coreID:
        int: 23
      cpuID:
        int: 95
      numaAffinityMask:
        string: 0xffffff000000ffffff000000
      numaNode:
        int: 1
    name: cpu95
  driver: dra.cpu
  nodeName: kind-worker
  pool:
    generation: 1
    name: kind-worker
    resourceSliceCount: 1
```

- DeviceClass, ResourceClaim objects included in `examples/` dir.

- CDI file on the node

```
    root@kind-worker:/var/run/cdi# ls
    dra.cpu.json
    root@kind-worker:/var/run/cdi# cat dra.cpu.json
    {
    "cdiVersion": "1.0.0",
    "kind": "dra.k8s.io/cpu",
    "devices": [
        {
        "name": "claim-826e3ba8-ab40-43fd-8167-5896960b591e",
        "containerEdits": {
            "env": [
            "DRA_CPUSET_claim_dummy-cpu-request=0-3"
            ]
        }
        },
        {
        "name": "claim-611ecefc-bc8e-49ca-93a5-21019ba2a660",
        "containerEdits": {
            "env": [
            "DRA_CPUSET_claim_dummy-cpu-request-2=4-9"
            ]
        }
        }
    ],
    "containerEdits": {}
    }
```
